---
layout:     article

title:      "Unix/Linux 编程实践教程第四章习题"

subtitle:   ""

date:       2019-7-16

author:     "thewangcj"

header-img: ""

catalog: false

tags:
    - Linux
    - C
---

> “仅供参考”

------

#### 4 .1
这个硬件位置一般称作 `CHS` 地址，既磁头数（Heads）、柱面数（Cylinders）、 扇区数（Sectors），而在系统中描述数据所在的区块称作 `LBA` (逻辑区块地址)，这种寻址方式把硬盘看成一个大的数组，每一个数据块有一个编号。两个地址进行转换时要注意：由于系统在写入数据时是按照从柱面到柱面的方式，在上一个柱面写满数据后才移动磁头到下一个柱面，并从柱面的第一个磁头的第一个扇区开始写入，从而使磁盘性能最优，所以，在对物理扇区进行线性编址时，也按照这种方式进行。即把第一柱面（0柱）第一磁头（0面）的第一扇区（1扇区）编为逻辑“0”扇区，把第一柱面（0柱）第一磁头（0面）的第二扇区（2扇区）编为逻辑 “1” 扇区，直至第一柱面（0柱）第一磁头（0面）的第63扇区（63扇区）编为逻辑“62”扇区，然后转到第一柱面（0柱）第二磁头（1面）的第一扇区（1扇区），接着上面编为逻辑 “63” 扇区，0柱面所有扇区编号完毕后转到1柱面的0磁头1扇区，依次往下进行，直至把所有的扇区都编上号。从这个关系就可以推测出 `LBA` 到 `CHS` 的转换公式：这里规定用 `C` 表示当前柱面号，`H` 表示当前磁头号，`S` 表示当前扇区号，`CS` 表示起始柱面号，`HS` 表示起始磁头号，`SS` 表示起始扇区号，`PS` 表示每磁道扇区数，`PH` 表示每柱面磁道数。
<!--more-->

C=LBA div (PH﹡PS) + CS  
H=(LBA div PS)MOD PH + HS  
S=LBA MOD PS + SS

#### 4.2
查看数据块的大小，我查看后是4096字节：
```shell
stat -f .
```
查看磁盘分区及数据块信息，这里可以使用
```shell
df --block-size=4096
```
查看每个分区 i-节点 信息：
```shell
df -i
```

#### 4.4
`inode Bitmap`: inode 位图，用二进制的方式记录了 inode 的使用情况，比如 inode 是否空闲等。
`Block Bitmap`: 块位图，类型 inode 位图，用二级制记录块的使用情况，当查找或创建文件时，会扫描此位图来寻找空闲 inode 号对应的块。
`Bitmap` 中，每一个 `bit` 表示一个块，为 1 表示该块已用，为 0 表示该块空闲可用。

#### 4.5
不会

#### 4.6
1. 在 `ext2`文件系统上，结构体`ext2_inode_info` 中定义了数据块列表 `i_data[15]`，在`ext4`文件系统中，结构体`ext4_inode`中定义了数据块列表 `i_block[EXT4_N_BLOCKS]`，其中`EXT4_N_BLOCKS`也是15，共有12个直接块，一级、二级、三级间接快各一个。

2. 使用`df`命令可以查看文件系统信息，找到系统根目录所在磁盘，我这里是`sda7`，然后通过
   ```shell
   dumpe2fs /dev/sda7
   ```
   
   查看该磁盘的所有信息，其中`Block size`表示块大小，我这里是`4096`也就是`4KB`
   
3. 直接块一共12个，每个块大小4KB，所以不使用间接块的文件最大是48KB

4. 一个索引地址是4个字节，那么一个间接块可以存放1024个数据块，在加上12个直接块，最大可以表示4144KB的文件

#### 4.7
目录的链接数指的是目录的硬链接，即目录有多少个别名，创建目录时，默认会生成两个目录项：`.`和`..`。前者的 inode 号码就是当前目录的 inode 号码，等同于当前目录的"硬链接"；后者的 inode 号码就是当前目录的父目录的 inode 号码，等同于父目录的"硬链接"。所以，任何一个目录的"硬链接"总数，总是等于2加上它的子目录总数（含隐藏目录）。

#### 4.8
在我的 deepin 中无法进行此操作，而且如果给目录建立硬链接可能造成死循环，比如在一个目录下创建一个硬链接指向该目录，那么便利的时候就会造成死循环。

#### 4.9
1. 显示 mount point /home2 does not exist
2. 可以装载，装载后装载点下的子目录和文件消失，umount 后子目录和文件又恢复了。

#### 4.10
为了防止偶然发生的误删事件，Unix/Linux 关于 rmdir 加了两条规则：第一条规则是不能移除非空的目录；第二条规则是不能删除工作目录和根目录之间的任何目录，工作目录就是你当前所在的目录，删除工作目录相当于你坐在一颗树上，却要把坐着的树枝砍掉一样，这显然是不合理的。

#### 4.11
硬盘通常由重叠的一组盘片构成，每个盘面都被划分为数目相等的磁道，并从外缘的“0”开始编号，具有相同编号的磁道形成一个圆柱，称之为磁盘的柱面。磁盘的柱面数与一个盘面上的磁道数是相等的。由于每个盘面都有自己的磁头，因此，盘面数等于总的磁头数。

#### 4.12
mke2fs 格式化工具的默认策略是一个块组有多少个 8KB 就分配多少个 inode。但是数据块的大小可能不是 8KB，比如是 1KB，那么 inode 的数量就小于数据块。如果平均每个文件的大小是8KB，当分区存满的时候inode表会得到比较充分的利用，数据块也不浪费。如果这个分区存的都是很大的文件（比如电影），则数据块用完的时候inode 会有一些浪费，如果这个分区存的都是很小的文件（比如源代码），则有可能数据块还没用完 inode 就已经用完了，数据块可能有很大的浪费。

#### 4.13
假设假设一个路径是 /opt/file，则查找的顺序是：
1. 读出 inode 表中第2项，也就是根目录的 inode，从中找出根目录数据块的位置
2. 从根目录的数据块中找出文件名为 opt 的记录，从记录中读出它的 inode 号
3. 读出 opt 目录的 inode，从中找出它的数据块的位置
4. 从 opt 目录的数据块中找出文件名为 file 的记录，从记录中读出它的 inode号
5. 读出 file 文件的 inode
6. 填充 stat 结构体并返回

---
参考资料:  
[磁盘、柱面、磁道、磁头、扇区](https://www.cnblogs.com/jjmcao/p/9506504.html)  
[Linux下对inode和块的理解](https://www.cnblogs.com/whych/p/9315723.html)  
[理解inode](http://www.ruanyifeng.com/blog/2011/12/inode.html)
