---
layout:     article

title:      "使用 libtasn1 库解析 Kerberos 网络包"

subtitle:   ""

date:       2021-9-30

author:     "thewangcj"

header-img: ""

catalog: false

tags:
    - C 网络协议



---

> “libtasn1”

------

<!--more-->

最近因工作需要，要从Kerberos（接下来简称krb5）的 pcap 文件中提取 cname 之类的字段，在网上搜了一大推，基本上都是介绍 krb5 的原理，其中我觉得讲的比较好的是《Wireshark网络分析就是这么简单》一书中的“无懈可击的Kerberos”，在微信读书里就可以收到，看完之后开始研究如何从 pcap 文件中提取想要字段的值，发现 wireshark 中展示的字段之间都有一些不知道是啥的数据，比如下面两幅图展示的：

![](C:\Users\wang.changjie\Documents\code\thewangcj.github.io\_posts\2021-9-3-libtasn1\pvno.png)

![](C:\Users\wang.changjie\Documents\code\thewangcj.github.io\_posts\2021-9-3-libtasn1\msg_type.png)

在 pvno 和 msg-type 中差了有4个字节，意义不明，百度了一大圈不知道为啥，同事看了下说它的格式看起来像是 tlv（type-len-value），算了算好像差不多是这样，然后Google了一圈，再结合Kerberos的[RFC文档]([rfc4120 (ietf.org)](https://datatracker.ietf.org/doc/html/draft-ietf-krb-wg-kerberos-clarifications-07))，发现Kerberos 使用了一个叫 [ASN.1](https://www.jianshu.com/p/3f094da4c2e6) 的抽象数据定义格式，并且将数据再通过 DER 编码方式（基本上可以看做稍微复杂一点的 TLV）编码了一下，我直接好家伙，ASN.1 定义了十多种基本数据格式，还有几种复合数据类型，这要是自己写代码手动解析工作量直接上天。

这里先插几句：

1. Kerberos 的 ASN.1 定义可以在其 RFC 文档的附录中找到，你要是不想手动复制下来（接下来要用到），在 [wireshark 源码]([epan/dissectors/asn1/kerberos/KerberosV5Spec2.asn · master · Wireshark Foundation / wireshark · GitLab](https://gitlab.com/wireshark/wireshark/-/blob/master/epan/dissectors/asn1/kerberos/KerberosV5Spec2.asn))里可以找到，直接下下来就好；
2. ASN.1 文件在 vscode 里没有高亮，看着很难受，可以安装一个就要 ASN.1 的插件，其中介绍部分讲了很多 ASN.1 的介绍之类（对 ASN.1 的吐槽）的可以好好看看；

这里做一个总结，Kerberos 使用  ASN.1 定义其整个数据结构，可以把它当做是一种比较负责的结构体，然后将这个结构体使用 DER 编码后就得到了我们在 wireshark 中看到的数据了。要是这么说难以理解的话可以做一个类比——Kerberos 使用 JSON 定义其使用的各种字段，然后将其用 BASE64 编码，这样是不是好理解一些。

---

有了上述基础知识：Kerberos 认证的基本流程、ASN.1 格式各个字段的基本了解（SEQUENCE  和 SEQUENCE OF 一定要搞明白）、DER（或者BER，DER 基本就是加了一点限制的 BER，是它的子集）编码，接下来就要正式提取 Kerberos 字段了。

经过搜索发现有两个库可以参考：[vlm/asn1c: The ASN.1 Compiler (github.com)](https://github.com/vlm/asn1c) 和 [Libtasn1 - GNU Project - Free Software Foundation](https://www.gnu.org/software/libtasn1/)，前者生成出来的 .c 文件过于复杂繁多，不够简洁，于是这里我选择了 Libtasn1，Libtasn1 的安装十分简单，从我上面给的链接下载最新版本解压后执行`./configure`，然后`make && make install` 即可，安装完后，源码不要删掉，里面 test 文件夹下有许多可以参考的代码，结合 [GNU Libtasn1 4.17.0](https://www.gnu.org/software/libtasn1/manual/libtasn1.html) 的官方文档使用更佳。

---

安装完 Libtasn1 后会有如下一个命令：`asn1Coding asn1Decoding asn1Parser`，我们先从 `asn1Parser` 和 `asn1Decoding` 入手熟悉下 Libtasn1 的基本用法，首先新建 example.asn 文件：（摘自官方文档，居然有语法错误你敢信！）

```ASN.1
MYPKIX1 {}

DEFINITIONS IMPLICIT TAGS ::=

BEGIN

OtherStruct ::= SEQUENCE {
    x       INTEGER,
    y       CHOICE {
    y1 INTEGER,
    y2 OCTET STRING
    }
}

Dss-Sig-Value ::= SEQUENCE {
    r       INTEGER,
    s       INTEGER,
    other   OtherStruct,
    z       INTEGER OPTIONAL
}

END
```

然后输入

```shell
ans1Parse example.asn
```

会在同级目录下生成一个`example_asn1_tab.c` 文件，其中包含了以后调用 Libtasn1 函数需要的一些数组。

接下来创建一个 `example.asg`文件，文件名随意，后缀名也随意，这个文件用于给我们上面定义的 ASN.1 赋值，内容如下：

```
dp MYPKIX1.Dss-Sig-Value

r 42
s 47
other.x 66
other.y y1
other.y.y1 15
z (NULL)
```

然后输入：

```
asn1Coding example.asn example.asg
```

会得到如下结果：

![](C:\Users\wang.changjie\Documents\code\thewangcj.github.io\_posts\2021-9-3-libtasn1\example_asn1Coding.png)

最下面的 16 个字节就是`Dss-Sig-Value` 这个数据类型赋值以后 DER 编码后的结果，看一下是不是和 Kerberos 在 wireshark 中展示的很像呢。

等等，我们要的不是对数据编码要的是解码啊！莫急，这就来了，上面我们得到的二进制文件保存到了 `example.out`文件里，现在我想从里面读出先前赋值的那些数据咋办呢，在命令行中输入：

```
asn1Decoding example.asn example.out MYPKIX1.Dss-Sig-Value
```

其中第三个参数表明要解码的类型，结果如下图所示，可以看到先前赋值的结果都解析出来了包括类型、名字和取值。

![](C:\Users\wang.changjie\Documents\code\thewangcj.github.io\_posts\2021-9-3-libtasn1\asn1Decoding.png)

---

上面介绍了使用命令行进行 ASN.1 文件的解析，数据的编解码，接下来介绍使用 Libtasn1 提供的 API 函数用代码完成这一过程